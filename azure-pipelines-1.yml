trigger: none

# =========================
# STAGE 1: SECURITY SCANS
# =========================
stages:
- stage: Security_Scans
  displayName: Security Scanning Stage
  jobs:
  - job: Scan_Tools
    displayName: Run Security Tools
    pool: Atiq-Pool
    steps:
    - checkout: self

    # TFSEC
    - task: PowerShell@2
      displayName: TFSEC
      inputs:
        targetType: inline
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          tfsec .

    # TFLINT
    - task: PowerShell@2
      displayName: TFLint
      inputs:
        targetType: inline
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          tflint --init
          tflint

    # INFRACOST
    - task: PowerShell@2
      displayName: Infracost
      env:
        INFRACOST_API_KEY: $(INFRACOST_API_KEY)
      inputs:
        targetType: inline
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          infracost breakdown --path .

    # TERRASCAN
    - task: PowerShell@2
      displayName: Terrascan
      inputs:
        targetType: inline
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          terrascan scan --iac-type terraform --iac-dir . --policy-type azure

# =========================
# STAGE 2: TERRAFORM PLAN
# =========================
- stage: Terraform_Plan
  displayName: Terraform Init Validate Plan
  dependsOn: Security_Scans
  jobs:
  - job: Terraform_Init_Plan
    pool: Atiq-Pool
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: TerraformTask@5
      displayName: Terraform Init
      inputs:
        provider: azurerm
        command: init
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
        backendServiceArm: connection-03
        backendAzureRmStorageAccountName: storagezia123
        backendAzureRmContainerName: container-zia-123
        backendAzureRmKey: terraform.tfstate

    - task: TerraformTask@5
      displayName: Terraform Validate
      inputs:
        provider: azurerm
        command: validate
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'

    - task: TerraformTask@5
      displayName: Terraform Plan
      inputs:
        provider: azurerm
        command: plan
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
        environmentServiceNameAzureRM: connection-03

# =========================
# STAGE 3: MANUAL APPROVAL
# =========================
- stage: Manual_Approval
  displayName: Manual Approval Stage
  dependsOn: Terraform_Plan
  jobs:
  - job: Approval
    displayName: Await Manual Approval
    pool: server
    steps:
    - task: ManualValidation@1
      inputs:
        notifyUsers: |
          khiljiatique@gmail.com
        instructions: |
          Please review:
          - Security Scan Results
          - Terraform Plan

          Approve to proceed further.
        timeoutInMinutes: 1440
