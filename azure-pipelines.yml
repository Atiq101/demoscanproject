trigger: none

pool:
  name: Atiq-Pool

stages:

# ===============================
# Stage 1: Terraform Init / Plan
# ===============================
- stage: Terraform
  displayName: "Terraform Init & Plan"
  jobs:
  - job: TerraformInitPlan
    displayName: "Terraform Init, Validate & Plan"
    steps:

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraform Init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
        backendServiceArm: 'connection-03'
        backendAzureRmStorageAccountName: 'storagezia123'
        backendAzureRmContainerName: 'container-zia-123'
        backendAzureRmKey: 'terraform.tfstate'

    - task: TerraformTask@5
      displayName: Terraform Validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'

    - task: TerraformTask@5
      displayName: Terraform Plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
        environmentServiceNameAzureRM: 'connection-03'


# ===============================
# Stage 2: Scanning Tools
# ===============================
- stage: Scanning
  displayName: "Security & Cost Scanning"
  dependsOn: Terraform
  condition: succeeded()
  jobs:
  - job: ScanningTools
    displayName: "Run Scanning Tools"
    steps:

    - task: PowerShell@2
      displayName: TFSEC
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          tfsec .

    - task: PowerShell@2
      displayName: TFLint
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          tflint --init
          tflint

    - task: PowerShell@2
      displayName: Infracost
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          infracost breakdown --path .

    - task: PowerShell@2
      displayName: Terrascan
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/environment/prod
          terrascan scan --iac-type terraform --iac-dir . --policy-type azure
                if ($LASTEXITCODE -ne 0) {
          Write-Host "Terrascan found issues, but pipeline will continue."
                  exit 0
                }


# ===============================
# Stage 3: Manual Approval
# ===============================
- stage: ManualApproval
  displayName: "Manual Validation"
  dependsOn: Scanning
  condition: succeeded()
  jobs:
  - job: Approval
    displayName: "Manual Approval Required"
    pool: server
    steps:
    - task: ManualValidation@1
      inputs:
        notifyUsers: 'khiljiatique@gmail.com'
        approvers: 'khiljiatique@gmail.com'
        instructions: 'approve kar da baa'
































# trigger: none

# pool: Atiq-Pool

# jobs:
# - job: Terraforinit 
#   displayName: Terraform init
#   steps:
#   - task: TerraformInstaller@1
#     inputs:
#       terraformVersion: 'latest'
#   - task: TerraformTask@5
#     displayName: Terraform init
#     inputs:
#       provider: 'azurerm'
#       command: 'init'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       backendServiceArm: 'connection-03'
#       backendAzureRmStorageAccountName: 'storagezia123'
#       backendAzureRmContainerName: 'container-zia-123'
#       backendAzureRmKey: 'terraform.tfstate'

#   - task: TerraformTask@5
#     displayName: Terraform validate
#     inputs:
#       provider: 'azurerm'
#       command: 'validate'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'

#   - task: TerraformTask@5
#     displayName: Terraform plan 
#     inputs:
#       provider: 'azurerm'
#       command: 'plan'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       environmentServiceNameAzureRM: 'connection-03'
   
# - job: ManualValidation
#   displayName: Maual Valiation
#   pool: server
#   steps:
#   - task: ManualValidation@1
#     inputs:
#       notifyUsers: 'khiljiatique@gmail.com'
#       approvers: 'khiljiatique@gmail.com'
#       instructions: 'approve kar da baa'


# - job: Terraform_Apply
#   displayName: Terraform Apply
#   dependsOn: ManualValidation
#   pool: Atiq-Pool
#   steps:

#   - task: TerraformInstaller@1
#     inputs:
#       terraformVersion: 'latest'

#   - task: TerraformTask@5
#     displayName: Terraform Init (Apply Job)
#     inputs:
#       provider: 'azurerm'
#       command: 'init'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       backendServiceArm: 'connection-03'
#       backendAzureRmStorageAccountName: 'storagezia123'
#       backendAzureRmContainerName: 'container-zia-123'
#       backendAzureRmKey: 'terraform.tfstate'
#       commandOptions: '-reconfigure'

#   - task: TerraformTask@5
#     displayName: Terraform Apply
#     inputs:
#       provider: 'azurerm'
#       command: 'apply'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       environmentServiceNameAzureRM: 'connection-03'
#       commandOptions: '-auto-approve'

# - job: Terraform_Destroy
#   displayName: Terraform Destroy
#   dependsOn: ManualValidation
#   pool: Atiq-Pool
#   condition: and(succeeded(), eq(variables['DESTROY'], 'true'))
#   steps:

#   - task: TerraformInstaller@1
#     inputs:
#       terraformVersion: 'latest'

#   - task: TerraformTask@5
#     displayName: Terraform Init (Destroy)
#     inputs:
#       provider: 'azurerm'
#       command: 'init'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       backendServiceArm: 'connection-03'
#       backendAzureRmStorageAccountName: 'storagezia123'
#       backendAzureRmContainerName: 'container-zia-123'
#       backendAzureRmKey: 'terraform.tfstate'
#       commandOptions: '-reconfigure'

#   - task: TerraformTask@5
#     displayName: Terraform Destroy
#     inputs:
#       provider: 'azurerm'
#       command: 'destroy'
#       workingDirectory: '$(System.DefaultWorkingDirectory)/environment/prod'
#       environmentServiceNameAzureRM: 'connection-03'
#       commandOptions: '-auto-approve'
